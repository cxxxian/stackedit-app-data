![输入图片说明](/imgs/2025-03-02/CMuTrzTPjFm95tjE.png)

![输入图片说明](/imgs/2025-03-02/QkZFzolDUY6MCfOK.png)

![输入图片说明](/imgs/2025-03-02/MV2YivenkBhoEIhT.png)

![输入图片说明](/imgs/2025-03-02/C5dNtfZLgovEQ03W.png)

![输入图片说明](/imgs/2025-03-02/QTL3EpopCCleo94k.png)

![输入图片说明](/imgs/2025-03-02/X6jhIM1SssuaazZG.png)

所以根据`opengl`的规则，其实可以解答疑惑，为什么`cubeMap`图片采样的时候不需要反转，但是正常`texture2D`需要，因为`cubeMap`就是把左上角当成`(0, 0)`点进行采样，而`texture2D`是把左下角当作`(0, 0)`点进行采样

![输入图片说明](/imgs/2025-03-02/UpW1FIaH2HZZNajE.png)

所以我们就可以依照规则求出`lightMatrix`，通过投影矩阵乘上视角矩阵，视角矩阵是通过规则得来

我们以前是将深度值直接写入到`shadowMap`当中，而`depth`是通过`ndc`求得，由下图可知会存在精度问题

![输入图片说明](/imgs/2025-03-02/M1IJtEt2lB0Y5vfA.png)

所以我们采用物体到光源得距离作为深度参考，这样就可以转化为线性问题

![输入图片说明](/imgs/2025-03-02/IxZrgsyEuis0DEZu.png)

`frag`中还有一个变量叫做`gl_FragDepth`，这样我们就可以输出自己计算的深度值而不是自动输出深度值了

![输入图片说明](/imgs/2025-03-02/FZE495sRtTJ8Lnui.png)

![输入图片说明](/imgs/2025-03-02/ugpdr4B9izy6CQGr.png)

# 实践（准备工作）
## 1 准备三件套：phongPointShadowMaterial + pointLightShadow + phongPointShadow.vert/frag
正常从原先基础复制即可，暂时不做修改
### 建立新的shadowPass的Shader
还有一个重要的事情，原本我们做`shadowMap`利用的是`shadow.vert/frag`，但是我们现在点光源渲染的`shadowMap`和以前不一样了，要渲染到`cubeMap`上面，而且使用的深度也是我们自己的自定义线性深度
所以重新建一个`shadowDistance.vert/frag`，用来专门对应此种`shadow Map`
## 2 加入架构：
### 在Light中加入PointLightShadow的生成
在`pointLight.cpp`中的构造函数加入`PointLightShadow`的生成
```cpp
#include "pointLight.h"
#include "shadow/pointLightShadow.h"

PointLight::PointLight() {
	mShadow = new PointLightShadow();
}
```
此时的`PointLightShadow`还是我们从`DirectionalLightShadow`复制过来的，后续再做修改
### 在render函数中兼容这些功能
在`render.h`中生成并到`render.cpp`中初始化两个`shader`
```cpp
Renderer::Renderer() {
	...
	mShadowDistanceShader = new Shader("assets/shaders/advanced/shadowDistance.vert", "assets/shaders/advanced/shadowDistance.frag");
	mPhongPointShadowShader = new Shader("assets/shaders/advanced/phongPointShadow.vert", "assets/shaders/advanced/phongPointShadow.frag");
}
```
此处````
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEwNzEyNjg4MTAsLTExOTE0MTAyMywxOT
ExNjg1MTY5LC0xOTg3MDI3NTQ4LDU2Njc3MzA4Miw1MDQzOTY5
NjgsLTEzODU2Mzk1OSwtMzU4Njc5NjEwLDM1Njk0MTM2NSw4NT
k4MTg0NTcsLTUxMjY0NjEzMCwtMjA4ODc0NjYxMiwtMjA4ODc0
NjYxMl19
-->