![输入图片说明](/imgs/2025-03-02/CMuTrzTPjFm95tjE.png)

![输入图片说明](/imgs/2025-03-02/QkZFzolDUY6MCfOK.png)

![输入图片说明](/imgs/2025-03-02/MV2YivenkBhoEIhT.png)

![输入图片说明](/imgs/2025-03-02/C5dNtfZLgovEQ03W.png)

![输入图片说明](/imgs/2025-03-02/QTL3EpopCCleo94k.png)

![输入图片说明](/imgs/2025-03-02/X6jhIM1SssuaazZG.png)

所以根据`opengl`的规则，其实可以解答疑惑，为什么`cubeMap`图片采样的时候不需要反转，但是正常`texture2D`需要，因为`cubeMap`就是把左上角当成`(0, 0)`点进行采样，而`texture2D`是把左下角当作`(0, 0)`点进行采样

![输入图片说明](/imgs/2025-03-02/UpW1FIaH2HZZNajE.png)

所以我们就可以依照规则求出`lightMatrix`，通过投影矩阵乘上视角矩阵，视角矩阵是通过规则得来

我们以前是将深度值直接写入到`shadowMap`当中，而`depth`是通过`ndc`求得，由下图可知会存在精度问题

![输入图片说明](/imgs/2025-03-02/M1IJtEt2lB0Y5vfA.png)

所以我们采用物体到光源得距离作为深度参考，这样就可以转化为线性问题

![输入图片说明](/imgs/2025-03-02/IxZrgsyEuis0DEZu.png)

`frag`中还有一个变量叫做`gl_FragDepth`，这样我们就可以输出自己计算的深度值而不是自动输出深度值了

![输入图片说明](/imgs/2025-03-02/FZE495sRtTJ8Lnui.png)

![输入图片说明](/imgs/2025-03-02/ugpdr4B9izy6CQGr.png)

# 实践（准备工作）
## 1 准备三件套：phongPointShadowMaterial + pointLightShadow + phongPointShadow.vert/frag

## 2 加入架构：
### 
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTg2ODI0OTIzNiwxOTExNjg1MTY5LC0xOT
g3MDI3NTQ4LDU2Njc3MzA4Miw1MDQzOTY5NjgsLTEzODU2Mzk1
OSwtMzU4Njc5NjEwLDM1Njk0MTM2NSw4NTk4MTg0NTcsLTUxMj
Y0NjEzMCwtMjA4ODc0NjYxMiwtMjA4ODc0NjYxMl19
-->