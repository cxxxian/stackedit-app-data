# parallaxMap（视差贴图）

![输入图片说明](/imgs/2025-02-23/rPsFTtKYeXrFpMXZ.png)

![输入图片说明](/imgs/2025-02-23/3VpPJngGTiqt4g2n.png)

![输入图片说明](/imgs/2025-02-23/0wWkfQm80XqQbtiH.png)

![输入图片说明](/imgs/2025-02-23/Xv2898RFWuo9cSNO.png)

意思就是，我们看向`A`点，如果表面的高度正确的话，应该看到的是`B`的颜色，而不是被`A`挡住

![输入图片说明](/imgs/2025-02-23/cCgN4I48Utz9goKC.png)

这里就是把：
在世界坐标系下的`viewDir`转换到`uv`坐标系下，通过乘上`TBN`的逆矩阵即可以转化

![输入图片说明](/imgs/2025-02-23/Hn6lVqclPSR99ftD.png)

但是我们在`vertexShader`中计算逆矩阵其实是很耗费性能的，此时我们可以注意到`TBN`其实是正交矩阵，只需转置即可得到逆矩阵

![输入图片说明](/imgs/2025-02-23/FjpBv3Qqk5MwoqY6.png)

采样`ParallaxMap`的值，深度值越大，说明偏移量越大，深度值为`0`，就代表无需偏移

举例，上面需要偏移长度`uv2`，下面偏移长度`uv1`
所以可以得出深度越大，偏移越多

![输入图片说明](/imgs/2025-02-23/UlaObhQLnXy4WOka.png)

所以我们就可以做出如下设计，根据采样的深度值来计算偏移量

![输入图片说明](/imgs/2025-02-23/gXonZyzy8JtPObMC.png)

但是引出问题，我们不能单单利用深度值直接乘上`viewDir.xy`，因为我们还会有视角方向的问题，
比如垂直看的话，视差效果就不明显，
斜着看的话，会很明显

怎么解决呢？
因为我们的`viewDir`是经过归一化的，
所以就可以通过`viewDir.xy / viewDir.z`来判断
比如以下较于垂直的情况，那相应的`viewDir.z`就比较大，就会导致`viewDir.xy / viewDir.z`变小，最后导致`offset`变小
较于倾斜的情况，那相应的`viewDir.z`就比较小，就会导致`viewDir.xy / viewDir.z`变大，最后导致`offset`变大

而且这里有一个重点，我们最后return变成了`uv - offset`，这是因为我们的`viewDir`转到`uv`坐标系下朝向的是`-z`轴，因为毕竟是朝下看的，所以这时候计算出来的`offset`就是负值

![输入图片说明](/imgs/2025-02-23/c16YzMNSoPcNbcSP.png)

最后最后，我们还要引入一个`heightScale`，用于调节`offset`，这个参数就是直接和观感挂钩，先前的`viewDir.xy / viewDir.z * height`都是有道理的，能对得上公式以及依据的。
但是这样得出来得效果不一定好，所以
<!--stackedit_data:
eyJoaXN0b3J5IjpbMjAwNDU3Nzg4MSwtMTM0NTk2ODYwMiwxMj
g2MzExMjgxLDIzNzY4MjA1NiwtMTM4Mjc5ODcxMSwtMTMwMjc5
NTg2NiwtMjA5NDk5NjA2MF19
-->