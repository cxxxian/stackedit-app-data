# ç†è®ºè®¾è®¡
å‰å‘æ¸²æŸ“æ˜¯ï¼š**æ¯æ¸²æŸ“ä¸€ä¸ªç‰©ä½“ â†’ è®¡ç®—å®Œæ•´å…‰ç…§ â†’ è¾“å‡ºé¢œè‰²**
å»¶è¿Ÿæ¸²æŸ“æ˜¯ï¼š

1.  ç¬¬ä¸€æ­¥ï¼ˆGBuffer Passï¼‰ï¼šæ¸²æŸ“æ‰€æœ‰ç‰©ä½“ï¼ŒæŠŠå‡ ä½•ä¿¡æ¯å†™å…¥å¤šä¸ªç¼“å†²ï¼ˆGBufferï¼‰ï¼š
    ä½ç½® / æ³•çº¿ / æ¼«åå°„é¢œè‰² / é•œé¢åå°„å‚æ•° ç­‰
        
2.  ç¬¬äºŒæ­¥ï¼ˆLighting Passï¼‰ï¼šéå†å…‰æºï¼Œ**åœ¨å±å¹•ç©ºé—´**ä¸­è¿›è¡Œå…‰ç…§è®¡ç®—ï¼Œç”Ÿæˆæœ€ç»ˆé¢œè‰²

å¼€å§‹è®¾è®¡
åœ¨åŸæœ¬å‰å‘æ¸²æŸ“çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬éœ€è¦
# æ”¹é€ æµç¨‹
## 1. åˆ›å»º GBuffer ç»“æ„

éœ€è¦åˆ›å»ºå¤šä¸ª FBO é¢œè‰²é™„ä»¶ï¼ˆGBufferï¼‰ï¼š
```cpp
// åˆ›å»º FBO
glGenFramebuffers(1, &gBufferFBO);
glBindFramebuffer(GL_FRAMEBUFFER, gBufferFBO);

// GBuffer åˆ†é‡
- Albedo + Specularï¼ˆRGBAï¼‰
- Normalï¼ˆRGB æˆ–ç¼–ç æˆ 2 åˆ†é‡ï¼‰
- Positionï¼ˆæˆ–æ·±åº¦ï¼‰

// æ¯ä¸ªä½¿ç”¨ glTexImage2D åˆ›å»ºå¹¶ attach åˆ° GL_COLOR_ATTACHMENTi
glFramebufferTexture2D(...);
```

å¯ä»¥è§£é‡Šä¸€ä¸‹è¿™ä¸ªå¤šä¸ªé¢œè‰²é™„ä»¶
### ä¸ºä»€ä¹ˆè¦å¤šä¸ª Color Attachmentï¼Ÿ

**å»¶è¿Ÿæ¸²æŸ“æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå…ˆæ”¶é›†â€œæè´¨ + å‡ ä½•ä¿¡æ¯â€ï¼Œç»Ÿä¸€åšå…‰ç…§**ã€‚

è¿™äº›ä¿¡æ¯æ— æ³•å¡è¿›ä¸€ä¸ªé¢œè‰²è¾“å‡ºï¼ˆColor Attachmentï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦**å¤šä¸ªé¢œè‰²ç¼“å†²ï¼ˆGBufferï¼‰**ï¼Œæ¯ä¸ªç”¨æ¥å­˜å‚¨ä¸åŒçš„ä¿¡æ¯ï¼š

`GL_COLOR_ATTACHMENT0`ï¼šAlbedo + Specularï¼Œè¡¨é¢é¢œè‰²ã€æè´¨å‚æ•°

`GL_COLOR_ATTACHMENT1`ï¼šæ³•çº¿ï¼ˆNormalï¼‰ï¼Œå…‰ç…§æ–¹å‘è®¡ç®—

`GL_COLOR_ATTACHMENT2`ï¼šä¸–ç•Œåæ ‡ / è§†ç©ºé—´ä½ç½®ï¼Œè®¡ç®—å…‰ç…§æ–¹å‘ã€è·ç¦»è¡°å‡

`GL_DEPTH_ATTACHMENT`ï¼šæ·±åº¦å€¼ï¼Œå…‰ç…§è®¡ç®—æ—¶è¿˜åŸä½ç½® / å±å¹•ç©ºé—´è£å‰ª

ğŸ‘‰ æ‰€ä»¥ï¼š
> â€œæ³•çº¿â€ã€â€œUVâ€ã€â€œé¢œè‰²â€ç­‰éƒ½è¢«**è¾“å‡ºåˆ°ä¸åŒçš„é¢œè‰² attachment ä¸­â€ï¼Œæ”¾åœ¨åŒä¸€ä¸ª FBO é‡Œã€‚

### æ˜¯ä¸æ˜¯å¤šä¸ª FBOï¼Ÿç­”æ¡ˆæ˜¯ âŒ **ä¸€ä¸ª FBO + å¤šä¸ª Color Attachment**

ä½ åªéœ€è¦ä¸€ä¸ª FBOï¼Œä½†ç»‘å®šå¤šä¸ªçº¹ç†ï¼š
```cpp
glGenFramebuffers(1, &gBufferFBO);
glBindFramebuffer(GL_FRAMEBUFFER, gBufferFBO);

// åˆ›å»ºå¤šä¸ªé¢œè‰² attachment çº¹ç†
glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, ..., gAlbedoTexture);
glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT1, ..., gNormalTexture);
glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT2, ..., gPositionTexture);

// æ·±åº¦ç¼“å†²
glFramebufferRenderbuffer(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, ..., depthBuffer);

// å‘Šè¯‰ OpenGL ä½ ä¼šå†™å…¥è¿™å‡ ä¸ªé¢œè‰²é™„ä»¶
GLenum attachments[3] = {
  GL_COLOR_ATTACHMENT0,
  GL_COLOR_ATTACHMENT1,
  GL_COLOR_ATTACHMENT2
};
glDrawBuffers(3, attachments);
```
æ‰€ä»¥ï¼š
-   **ä¸€ä¸ª FBO**ï¼šæ•´åˆå¤šä¸ª attachment
-   **å¤šä¸ª Attachmentï¼ˆGBufferï¼‰**ï¼šç”¨äº Geometry Pass æ—¶è¾“å‡ºå¤šä¸ªæ•°æ®é€šé“
-   **æ¯ä¸ª GBuffer æ˜¯ä¸€ä¸ªè´´å›¾ï¼ˆTextureï¼‰**ï¼Œä¹‹å Lighting Pass ä¼šç”¨å®ƒä»¬ä½œä¸ºè¾“å…¥

## 2. å®ç° Geometry Passï¼ˆå†™å…¥ GBufferï¼‰

-   ä½¿ç”¨ä¸€ä¸ªæ–°çš„ Shaderï¼ˆ`geometry_pass.vert / frag`ï¼‰
    
-   è¾“å‡ºï¼š
```cpp
out vec4 gAlbedoSpec;
out vec3 gNormal;
out vec3 gPosition;
```
ä¸åšå…‰ç…§è®¡ç®—ï¼Œåªå†™æ•°æ®åˆ°å¤šä¸ªç›®æ ‡

è®°å¾—ç”¨ï¼š
```cpp
GLenum attachments[3] = {GL_COLOR_ATTACHMENT0, 1, 2};
glDrawBuffers(3, attachments);
```
è¿™é‡Œæ˜¯ **OpenGL å¤šé‡æ¸²æŸ“ç›®æ ‡ï¼ˆMRTï¼ŒMultiple Render Targetsï¼‰** çš„å…³é”®è®¾ç½®
### è¿™æ®µä»£ç çš„ä½œç”¨ï¼š

å®ƒå‘Šè¯‰ OpenGLï¼š
> â€œå½“å‰ç»‘å®šçš„ FBO ä¸Šï¼Œæˆ‘è¦æŠŠ Fragment Shader çš„å¤šä¸ªè¾“å‡ºå†™å…¥å“ªäº›é¢œè‰²é™„ä»¶ï¼ˆColor Attachmentï¼‰ã€‚â€
## åˆ†è§£è§£é‡Šï¼š

### ğŸ”¸ `GLenum attachments[3] = {GL_COLOR_ATTACHMENT0, 1, 2};`

è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œè¡¨ç¤ºæˆ‘ä»¬å‡†å¤‡â€œæ¿€æ´»â€å“ªäº› `Color Attachment`ï¼ˆé¢œè‰²è¾“å‡ºæ§½ï¼‰ã€‚

æ­£ç¡®å†™æ³•åº”è¯¥æ˜¯ï¼š
```cpp
GLenum attachments[3] = {     
GL_COLOR_ATTACHMENT0,     
GL_COLOR_ATTACHMENT1,     
GL_COLOR_ATTACHMENT2 
};
```
### `glDrawBuffers(3, attachments);`

è¿™å¥è°ƒç”¨çš„å«ä¹‰æ˜¯ï¼š

> â€œå½“å‰è¿™ä¸ª FBO ä¸­ï¼Œæˆ‘çš„ Fragment Shader è¾“å‡ºè¦å†™å…¥è¿™ä¸‰ä¸ªé¢œè‰²ç›®æ ‡ã€‚â€

æ‰€ä»¥å¦‚æœä½ åœ¨ fragment shader ä¸­è¿™æ ·å†™ï¼š
ä¸Šé¢è¿™ä¸ªæ‰æ˜¯å®Œæ•´è¡¨è¾¾ä¸‰ä¸ªé¢œè‰²ç›®æ ‡ï¼š0ã€1ã€2ã€‚
```glsl
layout(location = 0) out vec4 gAlbedoSpec;
layout(location = 1) out vec3 gNormal;
layout(location = 2) out vec3 gPosition;
```
é‚£ä¹ˆï¼š

-   `gAlbedoSpec` â†’ å†™å…¥ `GL_COLOR_ATTACHMENT0`
-   `gNormal` â†’ å†™å…¥ `GL_COLOR_ATTACHMENT1`
-   `gPosition` â†’ å†™å…¥ `GL_COLOR_ATTACHMENT2`

è¿™æ · GBuffer çš„ä¸‰ä¸ªè´´å›¾å°±èƒ½ä¸€æ¬¡æ€§å†™å®Œï¼
### ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾ç½®ï¼Ÿ

å› ä¸º OpenGL é»˜è®¤åªå†™å…¥ `GL_COLOR_ATTACHMENT0`ï¼Œå¦‚æœä½ è¦**å¯ç”¨å¤šä¸ªè¾“å‡º**ï¼ˆæ¯”å¦‚å»¶è¿Ÿæ¸²æŸ“çš„ GBufferï¼‰ï¼Œå°±å¿…é¡»å‘Šè¯‰ OpenGLï¼šâ€œæˆ‘è¦å†™å…¥å¤šä¸ª attachmentâ€ã€‚

----------

### ç±»æ¯”ç†è§£ï¼š

ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆï¼š

> "æˆ‘è¿™ä¸ªå¸§ç¼“å†²æœ‰å¥½å‡ ä¸ªå†™å…¥é€šé“ï¼Œå‘Šè¯‰ OpenGLæˆ‘æƒ³å¯ç”¨å“ªå‡ ä¸ªï¼Œå¹¶ä¸” Shader ä¸­çš„è¾“å‡ºè¦æ€ä¹ˆå¯¹å·å…¥åº§ã€‚"

## 3. å®ç° Lighting Passï¼ˆå…‰ç…§è®¡ç®—ï¼‰

-   ä½¿ç”¨ä¸€ä¸ªå…¨å± Quadï¼ˆæˆ–å±å¹•åæ ‡ä¸‰è§’å½¢ï¼‰
-   ç»‘å®šä¸Šä¸€æ­¥çš„ GBuffer ä¸ºè´´å›¾è¾“å…¥
-   å¯¹æ¯ä¸ªå…‰æºæ‰§è¡Œå±å¹•ç©ºé—´å…‰ç…§ï¼š

```cpp
vec3 albedo = texture(gAlbedo, uv).rgb;
vec3 normal = texture(gNormal, uv).xyz;
vec3 pos = texture(gPosition, uv).xyz;
vec3 lightDir = normalize(lightPos - pos);
vec3 diffuse = max(dot(normal, lightDir), 0.0) * lightColor * albedo;

```
## 4. åˆæˆ Passï¼ˆTone Mapping + Gamma + åå¤„ç†ï¼‰

-   è¾“å‡ºä¸€ä¸ªæœ€ç»ˆçš„é¢œè‰² FBO ç»“æœ
-   åº”ç”¨ Gamma æ ¡æ­£ã€Bloom ç­‰åå¤„ç†

## 5. è°ƒæ•´æ·±åº¦ & ç®¡çº¿æ§åˆ¶

-   ä½ éœ€è¦åˆç†ç®¡ç† `depth buffer`ï¼ŒGBuffer Pass å†™å…¥ `depth`ï¼ŒLight Pass ä¸å†™
-   å…‰ç…§ Pass ä¸­ç¦ç”¨æ·±åº¦å†™å…¥ï¼š
```cpp
glDisable(GL_DEPTH_TEST);
glDepthMask(GL_FALSE);
```
<!--stackedit_data:
eyJoaXN0b3J5IjpbNzkxNjkwMDkwLC04NTc0OTg4ODQsLTE4Mj
k3NDI4MSw3Njc2MzgyMDQsNTAzOTU5NjMxXX0=
-->