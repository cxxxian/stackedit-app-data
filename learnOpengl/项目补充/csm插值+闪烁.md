# æ’å€¼
## æ”¹åŠ¨çš„éƒ¨åˆ†ï¼ˆåŠ å…¥å±‚é—´å¹³æ»‘ï¼‰

```glsl
// ---------- æ–°å¢ Uniform ----------
uniform float cascadeBlendRange;     // ä¸–ç•Œç©ºé—´ä¸­ç”¨äºå±‚é—´æ··åˆçš„è¿‡æ¸¡å¸¦å®½åº¦

// ---------- æ–°å¢å‡½æ•°ï¼šè¿”å›ä¸¤ä¸ªå±‚ç´¢å¼•åŠæƒé‡ ----------
void getLayersAndWeight(float z, out int layer0, out int layer1, out float w){
    // æ‰¾åˆ°ä¸»å±‚ï¼ˆlayer0ï¼‰
    layer0 = 0;
    for(int i = 0; i < csmLayerCount; ++i){
        if(z < csmLayers[i]){ layer0 = i - 1; break; }
    }
    layer0 = clamp(layer0, 0, csmLayerCount - 1);
    layer1 = min(layer0 + 1, csmLayerCount - 1);

    // è®¡ç®—æ··åˆæƒé‡ wâˆˆ[0,1]
    float farBound = csmLayers[layer1];
    float blendStart = farBound - cascadeBlendRange;
    w = (z > blendStart && layer0 != layer1)
        ? smoothstep(0.0, 1.0, (z - blendStart) / cascadeBlendRange)
        : 0.0;
}

// ---------- æ›¿æ¢åŸæ¥çš„ csm(...) ----------
float csm(vec3 positionWorldSpace, vec3 normal, vec3 lightDir, float pcfRadius){
    // 1. ç›¸æœºç©ºé—´æ·±åº¦
    vec3 posCam = (viewMatrix * vec4(positionWorldSpace,1.0)).xyz;
    float z = -posCam.z;

    // 2. å–å¾—ä¸¤ä¸ªå±‚åŠæƒé‡
    int layer0, layer1; float w;
    getLayersAndWeight(z, layer0, layer1, w);

    // 3. ä¸»å±‚é‡‡æ ·
    vec4 clip0 = lightMatrices[layer0] * vec4(positionWorldSpace,1.0);
    float s0 = pcf(clip0, layer0, normal, lightDir, pcfRadius);

    // 4. è‹¥åœ¨è¿‡æ¸¡å¸¦ï¼Œå†é‡‡æ ·è¿œå±‚å¹¶æ··åˆ
    if(w == 0.0 || layer0 == layer1) return s0;

    vec4 clip1 = lightMatrices[layer1] * vec4(positionWorldSpace,1.0);
    float s1 = pcf(clip1, layer1, normal, lightDir, pcfRadius);

    return mix(s0, s1, w);   // å¹³æ»‘è¿‡æ¸¡
}

```

### ä½¿ç”¨è¯´æ˜

1.  **`cascadeBlendRange`** å»ºè®®å è¯¥â€¯cascadeâ€¯æ·±åº¦ 5â€¯%â€“10â€¯%ï¼ˆå•ä½=ä¸–ç•Œç©ºé—´ï¼‰ï¼›  
    ä¾‹ï¼š`cascadeBlendRange = 5.0`ï¼ˆæˆ–éšå±‚çº§æ¯”ä¾‹è°ƒèŠ‚ï¼‰ã€‚
    
2.  ä»ç„¶è°ƒç”¨åŸæ¥çš„ `shadow = csm(...)`ï¼Œå…¶å®ƒé€»è¾‘ä¿æŒä¸å˜ã€‚
    

è¿™æ ·ï¼Œå½“åƒç´ è½å…¥ç›¸é‚»ä¸¤å¼ â€¯shadowâ€‘map çš„é‡å åŒºæ—¶ï¼Œshader ä¼šè‡ªåŠ¨å†é‡‡æ ·ä¸‹ä¸€å±‚å¹¶ç”¨ `smoothstep` åšæƒé‡æ’å€¼ï¼Œçº¹ç†åˆ†è¾¨ç‡éª¤å˜å¸¦æ¥çš„äº®/æš—è·³å˜å³å¯æ¶ˆé™¤ã€‚

## æ€»ç»“
## æ’å€¼æ€ä¹ˆåšï¼Ÿ

æˆ‘ä»¬é€‰æ‹©â€œ**ä¸–ç•Œç©ºé—´ z æ·±åº¦**â€ä½œä¸ºæ’å€¼å› å­ï¼ˆä¹Ÿå¯ä»¥æ˜¯ç›¸æœºç©ºé—´ zï¼‰ï¼š

### æ’å€¼å…¬å¼ï¼š

```glsl
finalShadow = mix(shadow0, shadow1, w);
```

å…¶ä¸­ï¼š

-   `shadow0`ï¼šå½“å‰ cascadeï¼ˆè¿‘å±‚ï¼‰çš„é˜´å½±å€¼
    
-   `shadow1`ï¼šä¸‹ä¸€å±‚ cascadeï¼ˆè¿œå±‚ï¼‰çš„é˜´å½±å€¼
    
-   `w`ï¼šæƒé‡ï¼Œå–å€¼ [0,1]ï¼Œè¡¨ç¤ºåƒç´ åœ¨äº¤ç•Œå¤„çš„ä½ç½®

ç”¨å¤§ç™½è¯è®²å…¶å®è·Ÿè´´å›¾æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæ’å€¼æ­¥éª¤ä½“ç°åœ¨æœ€åè®¡ç®—å‡ºæ¥çš„`shadow`å€¼ï¼Œåœ¨ä¸¤ä¸ªç›¸é‚»å±‚çº§ä¹‹é—´ï¼Œå¯¹ä¸åŒä¸¤ä¸ª`shadowMap`å¾—å‡ºçš„`shadow`å€¼åšæ’å€¼å¾—å‡ºä¸€ä¸ªå¹³æ»‘è¿‡æ»¤

# é—ªçƒ
## ä¸€å¥è¯æ¦‚æ‹¬ï¼š

> å½“æ‘„åƒæœºæˆ–å…‰æºè½»å¾®ç§»åŠ¨æ—¶ï¼Œ**é˜´å½±çº¹ç†ä¸­çš„æ·±åº¦æ˜ å°„ texel æ²¡æœ‰ä¸ä¸–ç•Œç©ºé—´å›ºå®šå¯¹é½**ï¼Œå¯¼è‡´é˜´å½±è¾¹ç¼˜åœ¨å±å¹•ä¸Šâ€œè·³æ¥è·³å»â€ã€‚
> 
## åœºæ™¯è®¾å®šï¼š

ä»¥ **å®šå‘å…‰+CSM** ä¸ºä¾‹ï¼Œä½ ä¸ºæ¯ä¸ª cascade åˆ›å»ºäº†ä¸€ä¸ª **æ­£äº¤æŠ•å½±çŸ©é˜µ**ï¼š

```glsl
lightMatrix = proj * lightView;
```

è¿™ä¸ªæ­£äº¤çŸ©é˜µå®šä¹‰äº†å½“å‰ `shadow map` åœ¨å…‰æºç©ºé—´ä¸­èƒ½â€œçœ‹åˆ°â€çš„åŒºåŸŸï¼š

-   æ¯”å¦‚ï¼š`x âˆˆ [-50, 50], y âˆˆ [-50, 50]`ï¼Œå®½é«˜å…± `100` ä¸ªä¸–ç•Œå•ä½ï¼›
    
-   ä½ æŠŠå®ƒæ¸²æŸ“åˆ°ä¸€ä¸ª `2048Ã—2048` çš„ `shadow map` ä¸­ï¼›
    
-   æ‰€ä»¥ï¼š**æ¯ä¸ª texel å¤§çº¦å¯¹åº”ä¸–ç•Œç©ºé—´ä¸­çš„ 100/2048 â‰ˆ 0.0488 ä¸ªå•ä½**ã€‚
    

----------

## é—®é¢˜æ¥äº†

ä½ ä¼šå‘ç°ï¼Œ**åªè¦æ‘„åƒæœºç¨å¾®åŠ¨ä¸€åŠ¨ï¼ŒlightMatrix çš„æŠ•å½±ä¸­å¿ƒå°±ä¼šç§»åŠ¨ä¸€ç‚¹ç‚¹**ï¼Œæ¯”å¦‚ `0.01` çš„å•ä½ï¼Œä½† `shadow map` æ˜¯ç¦»æ•£çš„ `texel`ï¼Œå®ƒæ— æ³•â€œåŠæ ¼â€ç§»åŠ¨ï¼Œäºæ˜¯é‡‡æ ·ä½ç½®ä¼šè·³è·ƒï¼š

```cpp
æ‘„åƒæœºç§»åŠ¨å‰ï¼š
     ä¸–ç•Œç©ºé—´ç‚¹ P â†’ è½åˆ° shadow map ç¬¬ 512Ã—512 æ ¼

æ‘„åƒæœºå¾®åŠ¨ï¼š
     ä¸–ç•Œç©ºé—´ç‚¹ P â†’ è½åˆ° shadow map ç¬¬ 513Ã—512 æ ¼
```

è¿™æ—¶å³ä½¿é˜´å½±åœ¨çœŸå®ä¸–ç•Œä¸­æ²¡æœ‰åŠ¨ï¼Œ**å±å¹•ä¸Šçš„é˜´å½±å°±è·³äº†ä¸€æ ¼**ï¼Œä½ çœ‹åˆ°çš„å°±æ˜¯**é—ªçƒæˆ–æ¸¸ç§»ç°è±¡**ã€‚

å†è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆ`lightMatrix`ä¼šå’Œæ‘„åƒæœºæ‰¯ä¸Šå…³ç³»ï¼Œæ˜æ˜`lightMatrix`åªå’Œå…‰æºæœ‰å…³å•Šã€‚
ä¸»è¦åŸå› å°±æ˜¯æˆ‘ä»¬ç°åœ¨åšçš„æ˜¯`CSM`ï¼Œè¿™ä¸ªåŒ…å›´ç›’æˆ‘ä»¬æ˜¯åˆ©ç”¨ç©å®¶è§†è§’çš„æ‘„åƒæœºä»`NDC`å»åæ¨å‡ºä¸–ç•Œåæ ‡çš„ï¼æ‰€ä»¥è¿™é‡Œå°±å’Œç©å®¶è§†è§’æ‘„åƒæœºæ‰¯ä¸Šå…³ç³»äº†


----------

## æ€ä¹ˆè§£å†³ï¼Ÿ

æˆ‘ä»¬è¦åšçš„æ˜¯ï¼š

> è®© shadow map çš„çº¹ç†åæ ‡ **å›ºå®šåœ¨ä¸–ç•Œç©ºé—´çš„æ•´æ•° texel æ ¼ä¸Š**ï¼Œä¹Ÿå°±æ˜¯ï¼š**é”å®šæŠ•å½±ä¸­å¿ƒï¼Œä½¿å…¶å§‹ç»ˆå¯¹é½åˆ° texel å¤§å°çš„æ•´æ•°å€**ã€‚

----------

### è®¡ç®—æ­¥éª¤ï¼ˆæ ¸å¿ƒï¼‰

ä½ å¯ä»¥åœ¨æ„é€  lightView â†’ lightProj çŸ©é˜µæ—¶ï¼ŒåŠ ä¸€æ­¥ **å¯¹ä¸­å¿ƒåæ ‡è¿›è¡Œ texel çº§å¯¹é½**ã€‚

å‡è®¾ï¼š

-   shadow map åˆ†è¾¨ç‡ï¼š`resolution = 2048`
    
-   ä½ å·²ç»å¾—å‡ºå½“å‰è§†é”¥åœ¨å…‰æºç©ºé—´ä¸‹çš„æ­£äº¤åŒ…å›´ç›’å¤§å°ä¸º `width, height`ï¼ˆæ¯”å¦‚ 100ï¼‰
    
-   é‚£ä¹ˆä¸€ä¸ª texel å¯¹åº”çš„ä¸–ç•Œå•ä½å¤§å°ï¼š

```glsl
float worldTexelSize = width / resolution;
```

ç„¶åä½ å¯¹åŒ…å›´ç›’ä¸­å¿ƒ `vec3 centerWS` åšå¯¹é½ï¼š

```glsl
vec3 centerLS = lightView * vec4(centerWS, 1.0);  // è½¬åˆ° light space

centerLS.xy = worldTexelSize * floor(centerLS.xy / worldTexelSize); // å‘ä¸‹å¯¹é½
```


ç„¶åç”¨å¯¹é½åçš„ä¸­å¿ƒ `centerLS` æ„é€ æ–°çš„æ­£äº¤æŠ•å½±ç›’ â†’ æŠ•å½±çŸ©é˜µã€‚

## è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ›´æ¸…æ™°çš„å¼„æ‡‚

### ç®€åŒ–é—®é¢˜ç‰ˆæœ¬ï¼š

ä½ æœ‰ä¸€ä¸ªç‰©ä½“ç‚¹ Pï¼Œåœ¨ä¸–ç•Œåæ ‡ç³»ä¸­æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚ï¼š

```
P_world = (5.0, 0.0, 5.0)     // åœ°é¢ä¸Šçš„æŸç‚¹
```

ä½ æ‘„åƒæœºè½»è½»åŠ¨äº†ä¸€ä¸‹ï¼Œæ¯”å¦‚ä» `(0.0, 5.0, -10.0) â†’ (0.01, 5.0, -10.0)`ï¼Œæƒ³è®©å®ƒå°½å¯èƒ½ä¸å½±å“é˜´å½±ã€‚

é—®é¢˜æ˜¯ï¼Œè¿™ä¸ªç‚¹ P æœ€ç»ˆé€šè¿‡ä»¥ä¸‹æµç¨‹æ˜ å°„åˆ° shadow mapï¼š

```
P_uv = (lightProj * lightView) * P_world;
```

lightView æ˜¯å…‰æºå›ºå®šæ–¹å‘å†³å®šçš„ï¼Œä½† **lightProj æ˜¯æ ¹æ®æ‘„åƒæœºåŒ…å›´ç›’è£å‡ºæ¥çš„**ï¼Œ  
æ‰€ä»¥åªè¦æ‘„åƒæœºè½»åŠ¨ä¸€ç‚¹ç‚¹ â†’ åŒ…å›´ç›’ä¸­å¿ƒä¹Ÿè½»å¾®æ”¹å˜ â†’ lightProj éšä¹‹å¾®è°ƒã€‚

äºæ˜¯ï¼š

-   æ²¡æœ‰å¯¹é½æ—¶ï¼š`lightMatrix` æ¯å¸§éƒ½ç•¥æœ‰ä¸åŒ â†’ P_uv æ¯å¸§è½åœ¨ä¸åŒ texel ä¸Š â†’ é˜´å½±åƒç´ é—ªçƒã€‚
    
-   å¯¹é½ä¹‹åï¼šæˆ‘ä»¬äººä¸ºå¼ºåˆ¶ `lightProj` ä¸­å¿ƒå¸é™„åˆ°â€œtexelç½‘æ ¼ç‚¹â€ï¼Œåªè¦åç§» **ä¸è¶…è¿‡ä¸€ä¸ª texel å®½**ï¼ŒæŠ•å½±ä¸­å¿ƒå°±ä¸åŠ¨ â†’ `lightMatrix` ä¸åŠ¨ â†’ é˜´å½±ç¨³å®š âœ…ã€‚
    

----------

### ğŸ” æˆ‘ä»¬ç°åœ¨æ›´ç»†åœ°çœ‹çœ‹ä¸¤ä¸ªç‰ˆæœ¬ï¼š

----------

### âŒ **ä¸å¯¹é½çš„ç‰ˆæœ¬ï¼š**

å‡è®¾ä½ ç¬¬ä¸€å¸§åŒ…å›´ç›’ä¸­å¿ƒè½åœ¨ï¼š

```cpp
centerLS.x = 1.023
```

ç¬¬äºŒå¸§å› ä¸ºæ‘„åƒæœºç¨å¾®åŠ¨äº†ä¸€ç‚¹ï¼Œå˜æˆï¼š

```cpp
centerLS.x = 1.026
```

è™½ç„¶åªå·® 0.003ï¼Œä½†è¿™ä¼šè®©æ•´ä¸ªæŠ•å½±çŸ©é˜µçš„ä¸­å¿ƒå˜æˆä¸åŒä½ç½® â†’  
P_world åœ¨ shadow map ä¸Šçš„ `uv` åæ ‡ä¹Ÿè·Ÿç€å¾®å˜ï¼Œä¾‹å¦‚ä» (0.502, 0.497) â†’ (0.505, 0.499)  
**è¿™æ ·ä¸€å˜åŒ–ï¼Œæœ€ç»ˆé‡‡æ ·çš„ texel å¯èƒ½å°±å˜äº†**ï¼Œå³ä½¿ç»“æœçœ‹èµ·æ¥å·®ä¸å¤šï¼Œä¹Ÿä¼šå¯¼è‡´ï¼š

> å±å¹•ä¸Šçš„åƒç´ çªç„¶ä»â€œäº®â€å˜â€œæš—â€ â†’ æŠ–åŠ¨ âŒ

----------

### âœ… **å¯¹é½åçš„ç‰ˆæœ¬ï¼š**

æˆ‘ä»¬åšäº†è¿™ä¸ªæ“ä½œï¼š

cpp

å¤åˆ¶ç¼–è¾‘

`centerLS.x = texelSize * floor(centerLS.x / texelSize);`

ä¸¾ä¾‹ï¼š

-   texelSize = 0.0488
    
-   `centerLS.x = 1.023` â†’ floor(1.023 / 0.0488) = 20 â†’ å¯¹é½åˆ° 20 Ã— 0.0488 = **0.976**
    
-   ç¬¬äºŒå¸§ï¼š`centerLS.x = 1.026` â†’ ä»ç„¶ floor(1.026 / 0.0488) = 20 â†’ **ä»ç„¶å¯¹é½åˆ° 0.976**
    

è™½ç„¶ä¸­å¿ƒå€¼å®é™…åœ¨å˜ï¼Œä½†æˆ‘ä»¬æŠŠå®ƒå¸é™„åˆ°äº†å›ºå®šä½ç½®ï¼Œ**åªè¦æ²¡æœ‰è·¨è¿‡ä¸€ä¸ªå®Œæ•´ texelï¼ˆ0.0488ï¼‰å°±ä¸å˜**ã€‚

äºæ˜¯ï¼š

> lightProj ä¸å˜ â†’ lightMatrix ä¸å˜ â†’ åŒä¸€ä¸ª P_world æ˜ å°„åˆ°ç›¸åŒçš„ `uv` â†’ é˜´å½±é‡‡æ ·ä¸è·³ â†’ å±å¹•åƒç´ ç¨³å®š âœ…

----------

## ğŸ§  æ›´å½¢è±¡çš„æ¯”å–»

æŠŠ shadow map çœ‹æˆä¸€å¼ çº¸ä¸Šçš„ç½‘æ ¼ï¼ˆæ ¼å­å¤§å° = texelSizeï¼‰

-   æ‘„åƒæœºåŠ¨ä¸€åŠ¨ï¼Œç­‰äºä½ æ‹–åŠ¨æ•´å¼ çº¸çš„â€œå¯è§†æ¡†â€
    
-   æ²¡å¯¹é½æ—¶ï¼šçº¸è·Ÿç€æ‘„åƒæœºè¿ç»­æ»‘åŠ¨ï¼Œæ ¼å­è¾¹ç¼˜åœ¨ä½ çœ¼ä¸­åœ¨â€œæ™ƒâ€
    
-   å¯¹é½åï¼šä½ åªå…è®¸è§†çª—æ¯æ¬¡æ»‘ä¸€ä¸ªæ ¼å­ï¼Œæ ¼å­å°±ç¨³å®šåœ°å¯¹é½è§†çª—ï¼Œä¸ä¼šåœ¨è§†è§‰ä¸Šè·³æ¥è·³å»
    

----------

## âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> **ä¸å¯¹é½æ—¶ï¼šæ¯å¸§çš„ lightMatrix æ€»æœ‰å¾®å°å˜åŒ–ï¼Œå¯¼è‡´é˜´å½±é‡‡æ ·è½åœ¨ä¸åŒ texelï¼Œäº§ç”Ÿé—ªçƒã€‚**  
> **å¯¹é½åï¼šåªè¦æ‘„åƒæœºæ²¡æœ‰è·¨è¿‡ä¸€ä¸ª texelï¼ŒlightMatrix å°±é”å®šä¸å˜ï¼Œé˜´å½±é‡‡æ ·ç‚¹å›ºå®šï¼Œå› æ­¤ç”»é¢ç¨³å®šã€‚**
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTIwODQwMjUzMTUsLTE5MzQ0Mzg4MjIsLT
E4NDE5NTUxOThdfQ==
-->